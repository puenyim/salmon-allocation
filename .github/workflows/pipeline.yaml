name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check Lint
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Unit test coverage using vitest
        run: npx vitest run --coverage --coverage.reporter=json-summary --coverage.reporter=html

      - name: Coverage summary table
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
          const fmt = (n) => n.toFixed(2) + '%';
          let md = '## ðŸ“Š Test Coverage Report\n\n';
          md += '| File | Statements | Branches | Functions | Lines |\n';
          md += '|------|-----------|----------|-----------|-------|\n';
          const total = data.total;
          md += '| **Total** | ' + fmt(total.statements.pct) + ' | ' + fmt(total.branches.pct) + ' | ' + fmt(total.functions.pct) + ' | ' + fmt(total.lines.pct) + ' |\n';
          for (const [file, metrics] of Object.entries(data)) {
            if (file === 'total') continue;
            const short = file.replace(process.cwd() + '/', '');
            md += '| ' + short + ' | ' + fmt(metrics.statements.pct) + ' | ' + fmt(metrics.branches.pct) + ' | ' + fmt(metrics.functions.pct) + ' | ' + fmt(metrics.lines.pct) + ' |\n';
          }
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md);
          "

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage

  build:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Upload build artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
